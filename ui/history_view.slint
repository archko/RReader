import { HorizontalBox, VerticalBox, ScrollView } from "std-widgets.slint";
import { UIRecent, HistoryRow } from "datatypes/history_datatypes.slint";

component HistoryItem inherits Rectangle {
    in property <string> title;
    in property <string> path;
    in property <image> thumbnail;
    in property <bool> has_thumbnail;

    callback item-clicked();

    in property <bool> hovered: touch-area.has-hover;

    background: hovered ? #f5f5f5 : #ffffff;
    border-radius: 4px;
    border-width: 1px;
    border-color: hovered ? #6200ee : #e0e0e0;

    drop-shadow-color: hovered ? #00000020 : #00000000;
    drop-shadow-blur: hovered ? 4px : 0px;

    VerticalBox {
        padding: 8px;
        spacing: 6px;

        Rectangle {
            background: #f5f5f5;
            height: 170px;

            Image {
                source: has_thumbnail ? thumbnail : @image-url("../assets/slint-logo-full-light.svg");
                width: 100%;
                height: 100%;
                image-fit: contain;
            }
        }

        Text {
            text: title;
            font-size: 14px;
            font-weight: 700;
            horizontal-alignment: left;
            wrap: no-wrap;
            color: root.hovered ? #6200ee : #000000;
        }

        Text {
            text: path;
            font-size: 13px;
            color: root.hovered ? #3700b3 : #666666;
            horizontal-alignment: left;
            wrap: no-wrap;
        }
    }

    touch-area := TouchArea {
        width: parent.width;
        height: parent.height;

        clicked => {
            root.item-clicked();
        }
    }
}

/// 历史记录视图组件
export component HistoryView {
    in property <[HistoryRow]> history_rows;
    callback viewport-changed(length, length);
    callback item-clicked(UIRecent);

    property <length> last-width: 0px;
    property <length> last-height: 0px;

    // 监听根组件大小变化
    changed width => {
        if (root.last-width != root.width && root.width > 0px) {
            root.last-width = root.width;
            root.viewport-changed(root.width, root.height);
        }
    }

    changed height => {
        if (root.last-height != root.height && root.height > 0px) {
            root.last-height = root.height;
            root.viewport-changed(root.width, root.height);
        }
    }

    scroller := ScrollView {
        width: root.width;
        height: root.height;

        VerticalBox {
            spacing: 8px;
            for row in history_rows : HorizontalBox {
                spacing: 8px;
                for item in row.items : HistoryItem {
                    width: 180px;
                    height: 240px;
                    title: item.title;
                    path: item.path;
                    thumbnail: item.thumbnail;
                    has_thumbnail: item.has_thumbnail;

                    item-clicked => {
                        root.item-clicked(item);
                    }
                }
            }
        }
    }
}
