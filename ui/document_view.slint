import { ScrollView } from "std-widgets.slint";
import { PageData } from "datatypes/document_datatypes.slint";

export component DocumentView inherits Rectangle {
    in property <[PageData]> pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in-out property <length> viewport-width: 0px;
    in-out property <length> viewport-height: 0px;

    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    callback page-clicked(float, float, int);

    border-width: 1px;
    border-color: #e0e0e0;

    property <length> last-visible-width: 0px;
    property <length> last-visible-height: 0px;

    scroller := ScrollView {
        width: root.width;
        height: root.height;
        viewport-width: max(root.total-width, root.width);
        viewport-height: max(root.total-height, root.height);
        viewport-x <=> root.offset-x;
        viewport-y <=> root.offset-y;
        mouse-drag-pan-enabled: true;

        content := Rectangle {
            clip: true;

            for page in pages: Rectangle {
                x: page.x * 1px;
                y: page.y * 1px;
                width: page.width * 1px;
                height: page.height * 1px;
                border-width: 1px;
                border-color: #d0d0d0;
                clip: true;

                if page.image.width > 0 && page.image.height > 0: Image {
                    width: parent.width;
                    height: parent.height;
                    source: page.image;
                    image-fit: fill;
                }

                // 显示页码（如果没有图片）
                if !(page.image.width > 0 && page.image.height > 0): Text {
                    text: "Page " + (page.page_index + 1);
                    font-size: 24px;
                    color: #999999;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                TouchArea {
                    pointer-event(event) => {
                        if event.kind == PointerEventKind.down && event.button == PointerEventButton.left {
                            //debug("down.event", (self.mouse-x / 1px), (self.mouse-y / 1px), event);
                            root.page-clicked(self.mouse-x / 1px, self.mouse-y/ 1px, page.page_index);
                        }
                    }
                }
            }
        }

        scrolled => {
            //debug("scrolled", (scroller.viewport-x / 1px), (scroller.viewport-y / 1px));
            if (!scroll_timer.running) {
                scroll_timer.running = true;
            } else {
                scroll_timer.restart();
            }
        }
    }

    focus := FocusScope {
        key-pressed(event) => {
            if (event.text == Key.Space || event.text == Key.PageDown) {
                root.offset-y = root.offset-y - (root.viewport-height - 48px) + 28px;
                root.scroll-changed(root.offset-x, root.offset-y);
                return accept;
            } else if (event.text == Key.PageUp) {
                root.offset-y = root.offset-y + (root.viewport-height - 48px) - 28px;
                root.scroll-changed(root.offset-x, root.offset-y);
                return accept;
            } else if (event.text == Key.Home) {
                root.offset-y = 0px;
                root.scroll-changed(root.offset-x, root.offset-y);
                return accept;
            } else if (event.text == Key.End) {
                root.offset-y = - root.viewport-height;
                root.scroll-changed(root.offset-x, root.offset-y);
                return accept;
            }
            reject
        }
    }

    viewport_timer := Timer {
        interval: 200ms;
        running: true;
        triggered => {
            if (root.last-visible-width != scroller.visible-width || root.last-visible-height != scroller.visible-height) {
                root.last-visible-width = scroller.visible-width;
                root.last-visible-height = scroller.visible-height;
                //debug("viewport-changed", (root.last-visible-width / 1px), (root.last-visible-height / 1px));
                root.viewport-width = scroller.visible-width;
                root.viewport-height = scroller.visible-height;
                root.viewport-changed(scroller.visible-width, scroller.visible-height);
                //不加这个,绘制不会刷新
                scroll-changed(root.offset_x, root.offset_y);
            }
            viewport_timer.restart();
        }
    }

    //不是每滚动一像素都更新,作个节流,如果机器比较强,可以不节流,直接在scrolled上面更新
    scroll_timer := Timer {
        interval: 50ms;
        running: false;
        triggered => {
            //debug("scroll-changed", (root.offset_x / 1px), (root.offset_y / 1px));
            scroll-changed(root.offset_x, root.offset_y);
            self.running = false;
        }
    }
}
