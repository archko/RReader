import { Button, VerticalBox, HorizontalBox, ScrollView, ListView } from "std-widgets.slint";

export struct PageData {
    x: float,
    y: float,
    width: float,
    height: float,
    image: image,
    page_index: int,
}

export struct UIRecent {
    title: string,
    path: string,
    thumbnail: string,
    page: int,
    zoom: float,
    scroll_x: int,
    scroll_y: int,
}

export struct UIOutlineItem {
    title: string,
    page: int,
    level: int,
}

component DocumentView inherits Rectangle {
    in property <[PageData]> pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in property <bool> enable-scroll-events: true;
    in-out property <length> viewport-height: 0px;

    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    callback page-down();
    callback page-up();
    callback page-clicked(float, float, int);

    background: #fafafa;
    border-width: 1px;
    border-color: #e0e0e0;
    clip: true;

    property <length> last-visible-width: 0px;
    property <length> last-visible-height: 0px;
    property <length> desired_offset_x: 0px;
    property <length> desired_offset_y: 0px;
    
    scroller := ScrollView {
        width: root.width;
        height: root.height;
        viewport-width: max(root.total-width, self.width);
        viewport-height: max(root.total-height, self.height);
        viewport-x <=> root.offset-x;
        viewport-y <=> root.offset-y;
        mouse-drag-pan-enabled: true;
        
        content := Rectangle {
            width: max(root.total-width, scroller.visible-width);
            height: max(root.total-height, scroller.visible-height);
            background: #ffffff;
            clip: true;
            
            for page in pages: Rectangle {
                x: page.x * 1px;
                y: page.y * 1px;
                width: page.width * 1px;
                height: page.height * 1px;
                border-width: 1px;
                border-color: #d0d0d0;
                clip: true;

                Image {
                    width: parent.width;
                    height: parent.height;
                    source: page.image;
                    image-fit: fill;
                }

                TouchArea {
                    pointer-event(event) => {
                        if event.kind == PointerEventKind.down && event.button == PointerEventButton.left {
                            //debug("down.event", (self.mouse-x / 1px), (self.mouse-y / 1px), event);
                            root.page-clicked(self.mouse-x / 1px, self.mouse-y/ 1px, page.page_index);
                        }
                    }
                }
            }
        }
        
        scrolled => {
            if (root.enable-scroll-events) {
                root.desired_offset_x = scroller.viewport-x;
                root.desired_offset_y = scroller.viewport-y;
                if (!scroll_timer.running) {
                    scroll_timer.running = true;
                } else {
                    scroll_timer.restart();
                }
            }
        }
    }
    
    focus := FocusScope {
        key-pressed(event) => {
            if (event.text == Key.Space) {
                root.page-down();
                return accept;
            } else if (event.text == Key.PageDown) {
                root.page-down();
                return accept;
            } else if (event.text == Key.PageUp) {
                root.page-up();
                return accept;
            }
            reject
        }
    }
    
    viewport_timer := Timer {
        interval: 200ms;
        running: true;
        triggered => {
            if (root.last-visible-width != scroller.visible-width || root.last-visible-height != scroller.visible-height) {
                root.last-visible-width = scroller.visible-width;
                root.last-visible-height = scroller.visible-height;
                root.viewport-height = scroller.visible-height;
                root.viewport-changed(scroller.visible-width, scroller.visible-height);
            }
            viewport_timer.restart();
        }
    }

    scroll_timer := Timer {
        interval: 200ms;
        running: false;
        triggered => {
            scroll-changed(root.desired_offset_x, root.desired_offset_y);
            self.running = false;
        }
    }
}

component HistoryItem inherits Rectangle {
    in property <string> title;
    in property <string> path;
    in property <string> thumbnail;

    callback item-clicked();
    
    // 使用TouchArea的has-hover属性来检测悬停状态
    in property <bool> hovered: touch-area.has-hover;
    
    background: hovered ? #f5f5f5 : #ffffff;
    border-radius: 4px;
    border-width: 1px;
    border-color: hovered ? #6200ee : #e0e0e0;
    // 添加阴影效果增强悬停视觉效果
    drop-shadow-color: hovered ? #00000020 : #00000000;
    drop-shadow-blur: hovered ? 4px : 0px;
    
    VerticalBox {
        padding: 8px;
        spacing: 6px;
        
        Rectangle {
            background: #f5f5f5;
            height: 120px;
            
            Image {
                source: @image-url("../assets/slint-logo-full-light.svg");
                width: 100%;
                height: 100%;
                image-fit: contain;
            }
        }
        
        Text {
            text: title;
            font-size: 14px;
            font-weight: 700;
            horizontal-alignment: left;
            wrap: no-wrap;
            color: root.hovered ? #6200ee : #000000;
        }
        
        Text {
            text: path;
            font-size: 12px;
            color: root.hovered ? #3700b3 : #666666;
            horizontal-alignment: left;
            wrap: no-wrap;
        }
    }
    
    touch-area := TouchArea {
        width: parent.width;
        height: parent.height;

        clicked => {
            root.item-clicked();
        }
    }
}

export component MainWindow inherits Window {
    title: "PDF Reader";
    width: 1024px;
    height: 768px;

    in property <int> page-count: 0;
    in-out property <int> current-page: 0;
    in-out property <float> zoom: 1.0;
    in property <[PageData]> document-pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in-out property <bool> scroll-events-enabled: true;
    in property <string> file-path: "/book/sample.pdf";
    in property <bool> document-opened: false;
    in property <[UIRecent]> history-items: [];
    in-out property <length> viewport-height: 0px;
    in-out property <bool> outline-visible: false;
    in property <[UIOutlineItem]> outline-items: [];
    
    callback open-file();
    callback page-changed(int);
    callback zoom-changed(float);
    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    callback back-to-history();
    callback page-down();
    callback page-up();
    callback page-clicked(float, float, int);
    callback history-item-clicked(UIRecent);

    Rectangle {

        VerticalBox {
            visible: !root.document-opened;
            
            Rectangle {
                height: 48px;
                background: #f5f5f5;
                border-width: 1px;
                border-color: #e0e0e0;
                
                HorizontalBox {
                    alignment: start;
                    padding: 12px;
                    spacing: 8px;
                    
                    Button {
                        text: "Clear";
                        clicked => { }
                    }
                    
                    Button {
                        text: "Open";
                        clicked => { open-file(); }
                    }
                }
            }
            
            VerticalBox {
                spacing: 8px;
                HorizontalBox {
                    spacing: 8px;
                    for item in root.history-items: HistoryItem {
                        width: 160px;
                        height: 200px;
                        title: item.title;
                        path: item.path;
                        thumbnail: item.thumbnail;

                        item-clicked => {
                            root.history-item-clicked(item);
                        }
                    }
                }
            }
        }
        
        VerticalBox {
            visible: root.document-opened;

            Rectangle {
                height: 48px;
                background: #f5f5f5;
                border-width: 1px;
                border-color: #e0e0e0;
                
                HorizontalLayout {
                    alignment: space-between;
                    HorizontalLayout {
                        alignment: start;
                        padding: 12px;
                        spacing: 8px;

                        Button {
                            text: "Back";
                            clicked => { back-to-history(); }
                        }
                        Button {
                            text: "Open";
                            clicked => { open-file(); }
                        }
                    
                        Text {
                            text: root.file-path;
                            vertical-alignment: center;
                            horizontal-alignment: left;
                            wrap: word-wrap;
                        }
                    }
                
                    HorizontalLayout {
                        alignment: end;

                        padding: 12px;
                        spacing: 8px;

                        Button {
                            text: "Previous";
                            enabled: root.current-page > 0;
                            clicked => { page-changed(root.current-page - 1); }
                        }
                    
                        Button {
                            text: "Next";
                            enabled: root.current-page < root.page-count - 1;
                            clicked => { page-changed(root.current-page + 1); }
                        }
                        
                        Button {
                            text: "Zoom -";
                            clicked => {
                                zoom = Math.max(0.5, zoom - 0.1);
                                zoom-changed(zoom);
                            }
                        }
                    
                        Button {
                            text: "Zoom +";
                            clicked => {
                                zoom = Math.min(4.0, zoom + 0.1);
                                zoom-changed(zoom);
                            }
                        }
    
                        Text {
                            text: Math.round(zoom * 100) + "%";
                            vertical-alignment: center;
                        }
    
                        Text {
                            text: "Page " + (root.current-page + 1) + " / " + Math.max(root.page-count, 1);
                            vertical-alignment: center;
                        }
                    }
                }
            }
            
            HorizontalLayout {
                vertical-stretch: 1;

                if root.outline-visible: ListView {
                    width: 180px;
                    for outline_item in root.outline-items : Rectangle {
                        height: 30px;
                        background: #ffffff;
                        width: parent.width;

                        HorizontalBox {
                            padding-left: outline_item.level * 10px;
                            spacing: 8px;

                            Text {
                                text: outline_item.title;
                                font-size: 12px;
                                horizontal-alignment: left;
                                wrap: no-wrap;
                            }

                            Text {
                                text: outline_item.page + 1;
                                font-size: 10px;
                                color: #666666;
                                horizontal-alignment: right;
                            }
                        }

                        Rectangle {
                            height: 1px;
                            background: #e0e0e0;
                            width: parent.width;
                            x: 0;
                            y: parent.height - 1px;
                        }

                        TouchArea {
                            width: parent.width;
                            height: parent.height;
                            clicked => {
                                root.page-changed(outline_item.page);
                            }
                        }
                    }
                }

                Button {
                    width: 24px;
                    text: root.outline-visible ? "◀" : "▶";
                    clicked => { outline-visible = !outline-visible; }
                }

                doc_view := DocumentView {
                    horizontal-stretch: 1;
                    pages: root.document-pages;
                    total-width: root.total-width;
                    total-height: root.total-height;
                    offset-x <=> root.offset-x;
                    offset-y <=> root.offset-y;
                    enable-scroll-events: root.scroll-events-enabled;
                    viewport-height <=> root.viewport-height;
                    viewport-changed(width, height) => { root.viewport-changed(width, height); }
                    scroll-changed(x, y) => { root.scroll-changed(x, y); }
                    page-down() => { root.page-down(); }
                    page-up() => { root.page-up(); }
                    page-clicked(x, y, page_index) => { root.page-clicked(x, y, page_index); }
                }
            }
        }
    }
}
