import { Button, VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";

export struct PageData {
    x: float,
    y: float,
    width: float,
    height: float,
    image: image,
}

component DocumentView inherits Rectangle {
    in property <[PageData]> pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in property <bool> enable-scroll-events: true;
    
    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    
    background: #fafafa;
    border-width: 1px;
    border-color: #e0e0e0;
    clip: true;
    
    property <length> last-visible-width: 0px;
    property <length> last-visible-height: 0px;
    
    scroller := ScrollView {
        width: root.width;
        height: root.height;
        viewport-width: max(root.total-width, self.width);
        viewport-height: max(root.total-height, self.height);
        viewport-x <=> root.offset-x;
        viewport-y <=> root.offset-y;
        mouse-drag-pan-enabled: true;
        
        content := Rectangle {
            width: max(root.total-width, scroller.visible-width);
            height: max(root.total-height, scroller.visible-height);
            background: #ffffff;
            clip: true;
            
            for page in pages: Rectangle {
                x: page.x * 1px;
                y: page.y * 1px;
                width: page.width * 1px;
                height: page.height * 1px;
                border-width: 1px;
                border-color: #d0d0d0;
                clip: true;
                
                Image {
                    width: parent.width;
                    height: parent.height;
                    source: page.image;
                    image-fit: fill;
                }
            }
        }
        
        scrolled => {
            if (root.enable-scroll-events) {
                root.scroll-changed(scroller.viewport-x, scroller.viewport-y);
            }
        }
    }
    
    viewport_timer := Timer {
        interval: 120ms;
        running: true;
        triggered => {
            if (root.last-visible-width != scroller.visible-width || root.last-visible-height != scroller.visible-height) {
                root.last-visible-width = scroller.visible-width;
                root.last-visible-height = scroller.visible-height;
            root.viewport-changed(scroller.visible-width, scroller.visible-height);
            }
            viewport_timer.restart();
        }
    }
}

export component MainWindow inherits Window {
    title: "PDF Reader";
    preferred-width: 1024px;
    preferred-height: 768px;
    
    in property <int> page-count: 0;
    in-out property <int> current-page: 0;
    in-out property <float> zoom: 1.0;
    in property <[PageData]> document-pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in-out property <bool> scroll-events-enabled: true;
    
    callback open-file();
    callback page-changed(int);
    callback zoom-changed(float);
    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    
    VerticalBox {
        spacing: 0px;
        
        Rectangle {
            height: 48px;
            background: #f5f5f5;
            border-width: 1px;
            border-color: #e0e0e0;
            
            HorizontalBox {
                padding: 12px;
                spacing: 8px;
                
                Button {
                    text: "Open";
                    clicked => { open-file(); }
                }
                
                Button {
                    text: "Previous";
                    enabled: root.current-page > 0;
                    clicked => { page-changed(root.current-page - 1); }
                }
                
                Button {
                    text: "Next";
                    enabled: root.current-page < root.page-count - 1;
                    clicked => { page-changed(root.current-page + 1); }
                }
                
                Rectangle { width: 1px; height: 100%; background: #d0d0d0; }
                
                Button {
                    text: "Zoom -";
                    clicked => {
                        zoom = Math.max(0.5, zoom - 0.1);
                        zoom-changed(zoom);
                    }
                }
                
                Button {
                    text: "Zoom +";
                    clicked => {
                        zoom = Math.min(4.0, zoom + 0.1);
                        zoom-changed(zoom);
                    }
                }

                Text {
                    text: Math.round(zoom * 100) + "%";
                    vertical-alignment: center;
                }
                
                Rectangle { width: 1px; height: 100%; background: #d0d0d0; }

                Text {
                    text: "Page " + (root.current-page + 1) + " / " + Math.max(root.page-count, 1);
                    vertical-alignment: center;
                }
            }
        }
        
        DocumentView {
            vertical-stretch: 1;
            min-height: 0px;
            pages: root.document-pages;
            total-width: root.total-width;
            total-height: root.total-height;
            offset-x <=> root.offset-x;
            offset-y <=> root.offset-y;
            enable-scroll-events: root.scroll-events-enabled;
            viewport-changed(width, height) => { root.viewport-changed(width, height); }
            scroll-changed(x, y) => { root.scroll-changed(x, y); }
        }
        
        Rectangle {
            height: 48px;
            background: #f5f5f5;
            border-width: 1px;
            border-color: #e0e0e0;
            
            HorizontalBox {
                padding: 12px;
                spacing: 16px;
                
                Text {
                    text: "Status: Ready";
                    font-size: 12px;
                    color: #666666;
                    vertical-alignment: center;
                }

                Text {
                    text: "Visible Page: " + (root.current-page + 1);
                    font-size: 12px;
                    color: #666666;
                    vertical-alignment: center;
                }
            }
        }
    }
}