import { Button, VerticalBox, HorizontalBox, ScrollView, ListView } from "std-widgets.slint";
import { PageData, UIRecent, UIOutlineItem, HistoryRow } from "types.slint";
import { DocumentView } from "document_view.slint";
import { HistoryView } from "history_components.slint";

export component MainWindow inherits Window {
    title: "PDF Reader";
    preferred-width: 1024px;
    preferred-height: 768px;
    min-width: 640px;
    min-height: 480px;
    default-font-family: "Simsun";

    in property <int> page-count: 0;
    in-out property <int> current-page: 0;
    in-out property <float> zoom: 1.0;
    in property <[PageData]> document-pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in-out property <bool> scroll-events-enabled: true;
    in property <string> file-path: "/book/sample.pdf";
    in property <bool> document-opened: false;

    in property <[UIRecent]> history-items: [];
    in property <[HistoryRow]> history-rows: [];
    in-out property <length> viewport-height: 0px;
    in-out property <bool> outline-visible: false;
    in property <[UIOutlineItem]> outline-items: [];
    
    callback open-file();
    callback page-changed(int);
    callback zoom-changed(float);
    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    callback back-to-history();
    callback page-down();
    callback page-up();
    callback page-clicked(float, float, int);
    callback history-item-clicked(UIRecent);
    callback history-viewport-changed(length, length);

    Rectangle {

        VerticalBox {
            visible: !root.document-opened;
            
            Rectangle {
                height: 48px;
                background: #f5f5f5;
                border-width: 1px;
                border-color: #e0e0e0;
                
                HorizontalBox {
                    alignment: start;
                    padding: 12px;
                    spacing: 8px;
                    
                    Button {
                        text: "Clear";
                        clicked => { }
                    }
                    
                    Button {
                        text: "Open";
                        clicked => { open-file(); }
                    }
                }
            }

            history_view := HistoryView {
                history-rows: root.history-rows;
                viewport-changed(width, height) => { root.history-viewport-changed(width, height); }
                item-clicked(item) => { root.history-item-clicked(item); }
            }
        }
        
        VerticalBox {
            visible: root.document-opened;

            Rectangle {
                height: 48px;
                background: #f5f5f5;
                border-width: 1px;
                border-color: #e0e0e0;
                
                HorizontalLayout {
                    alignment: space-between;
                    HorizontalLayout {
                        alignment: start;
                        padding: 12px;
                        spacing: 8px;

                        Button {
                            text: "Back";
                            clicked => { back-to-history(); }
                        }
                        Button {
                            text: "Open";
                            clicked => { open-file(); }
                        }
                    
                        Text {
                            text: root.file-path;
                            vertical-alignment: center;
                            horizontal-alignment: left;
                            wrap: word-wrap;
                        }
                    }
                
                    HorizontalLayout {
                        alignment: end;

                        padding: 12px;
                        spacing: 8px;

                        Button {
                            text: "Previous";
                            enabled: root.current-page > 0;
                            clicked => { page-changed(root.current-page - 1); }
                        }
                    
                        Button {
                            text: "Next";
                            enabled: root.current-page < root.page-count - 1;
                            clicked => { page-changed(root.current-page + 1); }
                        }
                        
                        Button {
                            text: "Zoom -";
                            clicked => {
                                zoom = Math.max(0.5, zoom - 0.1);
                                zoom-changed(zoom);
                            }
                        }
                    
                        Button {
                            text: "Zoom +";
                            clicked => {
                                zoom = Math.min(4.0, zoom + 0.1);
                                zoom-changed(zoom);
                            }
                        }
    
                        Text {
                            text: Math.round(zoom * 100) + "%";
                            vertical-alignment: center;
                        }
    
                        Text {
                            text: "Page " + (root.current-page + 1) + " / " + Math.max(root.page-count, 1);
                            vertical-alignment: center;
                        }
                    }
                }
            }
            
            HorizontalLayout {
                vertical-stretch: 1;

                if root.outline-visible: ListView {
                    width: 180px;
                    for outline_item in root.outline-items : Rectangle {
                        height: 30px;
                        background: #ffffff;
                        width: parent.width;

                        HorizontalBox {
                            padding-left: outline_item.level * 10px;
                            spacing: 8px;

                            Text {
                                text: outline_item.title;
                                font-size: 12px;
                                horizontal-alignment: left;
                                wrap: no-wrap;
                            }

                            Text {
                                text: outline_item.page + 1;
                                font-size: 10px;
                                color: #666666;
                                horizontal-alignment: right;
                            }
                        }

                        Rectangle {
                            height: 1px;
                            background: #e0e0e0;
                            width: parent.width;
                            x: 0;
                            y: parent.height - 1px;
                        }

                        TouchArea {
                            width: parent.width;
                            height: parent.height;
                            clicked => {
                                root.page-changed(outline_item.page);
                            }
                        }
                    }
                }

                Button {
                    width: 24px;
                    text: root.outline-visible ? "◀" : "▶";
                    clicked => { outline-visible = !outline-visible; }
                }

                doc_view := DocumentView {
                    horizontal-stretch: 1;
                    pages: root.document-pages;
                    total-width: root.total-width;
                    total-height: root.total-height;
                    offset-x <=> root.offset-x;
                    offset-y <=> root.offset-y;
                    enable-scroll-events: root.scroll-events-enabled;
                    viewport-height <=> root.viewport-height;
                    viewport-changed(width, height) => { root.viewport-changed(width, height); }
                    scroll-changed(x, y) => { root.scroll-changed(x, y); }
                    page-down() => { root.page-down(); }
                    page-up() => { root.page-up(); }
                    page-clicked(x, y, page_index) => { root.page-clicked(x, y, page_index); }
                }
            }
        }
    }
}
