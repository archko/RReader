import { Button, VerticalBox, HorizontalBox, ScrollView, ListView } from "std-widgets.slint";
import { PageData, OutlineItem } from "datatypes/document_datatypes.slint";
import { UIRecent, HistoryRow } from "datatypes/history_datatypes.slint";
import { DocumentView } from "document_view.slint";
import { HistoryView } from "history_view.slint";
import { HistoryToolbar } from "controls/history_toolbar.slint";
import { DocumentToolbar } from "controls/document_toolbar.slint";
import { OutlinePanel } from "controls/outline_panel.slint";
import { AppColors } from "style/styles.slint";
import { WindowInfo, WindowInfoHelper } from "ui_utils.slint";
import { BusyLayerController, BusyLayer } from "controls/busy-layer.slint";

// Re export for native rust
export { WindowInfo, BusyLayerController }

export component AppWindow inherits Window {
    title: "R-Reader";
    preferred-width: 1024px;
    preferred-height: 768px;
    min-width: 800px;
    min-height: 640px;
    default-font-family: "Simsun";

    in property <int> page-count: 0;
    in-out property <int> current-page: 0;
    in-out property <float> zoom: 1.0;
    in property <[PageData]> document-pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in-out property <bool> scroll-events-enabled: true;
    in property <string> file-path: "/book/sample.pdf";
    in property <bool> document-opened: false;

    in property <[UIRecent]> history-items: [];
    in property <[HistoryRow]> history-rows: [];
    in-out property <length> viewport-height: 0px;
    in-out property <bool> outline-visible: false;
    in property <[OutlineItem]> outline-items: [];

    callback open-file();
    callback page-changed(int);
    callback zoom-changed(float);
    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    callback back-to-history();
    callback page-down();
    callback page-up();
    callback page-clicked(float, float, int);
    callback history-item-clicked(UIRecent);
    callback history-viewport-changed(length, length);
    callback speak-page();
    callback clear-history();

    WindowInfoHelper {}

    Rectangle {
        background: AppColors.background;

        VerticalBox {
            visible: !root.document-opened;

            history_toolbar := HistoryToolbar {
                open-file => { root.open-file(); }
                clear-history => { root.clear-history(); }
            }

            history_view := HistoryView {
                history-rows: root.history-rows;
                viewport-changed(width, height) => { root.history-viewport-changed(width, height); }
                item-clicked(item) => { root.history-item-clicked(item); }
            }
        }

        VerticalBox {
            visible: root.document-opened;

            document_toolbar := DocumentToolbar {
                page-count: root.page-count;
                current-page: root.current-page;
                zoom: root.zoom;
                file-path: root.file-path;
                open-file => { root.open-file(); }
                back-to-history => { root.back-to-history(); }
                page-changed(page) => { root.page-changed(page); }
                zoom-changed(z) => { root.zoom-changed(z); }
                speak-page => { root.speak-page(); }
            }

            HorizontalLayout {
                vertical-stretch: 1;
                if root.outline-visible: outline_panel := OutlinePanel {
                    width: 250px;
                    outline-items: root.outline-items;
                    page-changed(page) => { root.page-changed(page); }
                }

                Rectangle {
                    width: 12px;
                    height: 100%;

                    Text {
                        text: root.outline-visible ? "◀" : "▶";
                        color: AppColors.accent;
                        font-weight: 500;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => { outline-visible = !outline-visible; }
                    }
                }

                doc_view := DocumentView {
                    horizontal-stretch: 1;
                    pages: root.document-pages;
                    total-width: root.total-width;
                    total-height: root.total-height;
                    offset-x <=> root.offset-x;
                    offset-y <=> root.offset-y;
                    enable-scroll-events: root.scroll-events-enabled;
                    viewport-height <=> root.viewport-height;
                    viewport-changed(width, height) => { root.viewport-changed(width, height); }
                    scroll-changed(x, y) => { root.scroll-changed(x, y); }
                    page-down() => { root.page-down(); }
                    page-up() => { root.page-up(); }
                    page-clicked(x, y, page_index) => { root.page-clicked(x, y, page_index); }
                }
            }
        }
    }

    if BusyLayerController.is-busy: BusyLayer {}
}
