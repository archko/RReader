import { Button, VerticalBox, HorizontalBox, ScrollView, ListView } from "std-widgets.slint";

export struct PageData {
    x: float,
    y: float,
    width: float,
    height: float,
    image: image,
}

component DocumentView inherits Rectangle {
    in property <[PageData]> pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in property <bool> enable-scroll-events: true;
    
    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    
    background: #fafafa;
    border-width: 1px;
    border-color: #e0e0e0;
    clip: true;
    
    property <length> last-visible-width: 0px;
    property <length> last-visible-height: 0px;
    
    scroller := ScrollView {
        width: root.width;
        height: root.height;
        viewport-width: max(root.total-width, self.width);
        viewport-height: max(root.total-height, self.height);
        viewport-x <=> root.offset-x;
        viewport-y <=> root.offset-y;
        mouse-drag-pan-enabled: true;
        
        content := Rectangle {
            width: max(root.total-width, scroller.visible-width);
            height: max(root.total-height, scroller.visible-height);
            background: #ffffff;
            clip: true;
            
            for page in pages: Rectangle {
                x: page.x * 1px;
                y: page.y * 1px;
                width: page.width * 1px;
                height: page.height * 1px;
                border-width: 1px;
                border-color: #d0d0d0;
                clip: true;
                
                Image {
                    width: parent.width;
                    height: parent.height;
                    source: page.image;
                    image-fit: fill;
                }
            }
        }
        
        scrolled => {
            if (root.enable-scroll-events) {
                root.scroll-changed(scroller.viewport-x, scroller.viewport-y);
            }
        }
    }
    
    viewport_timer := Timer {
        interval: 120ms;
        running: true;
        triggered => {
            if (root.last-visible-width != scroller.visible-width || root.last-visible-height != scroller.visible-height) {
                root.last-visible-width = scroller.visible-width;
                root.last-visible-height = scroller.visible-height;
            root.viewport-changed(scroller.visible-width, scroller.visible-height);
            }
            viewport_timer.restart();
        }
    }
}

component HistoryItem inherits Rectangle {
    in property <string> title;
    in property <string> path;
    in property <image> thumbnail;
    
    background: #ffffff;
    border-radius: 4px;
    border-width: 1px;
    border-color: #e0e0e0;
    
    VerticalBox {
        padding: 8px;
        spacing: 6px;
        
        Rectangle {
            background: #f5f5f5;
            height: 120px;
            
            Image {
                source: thumbnail;
                width: 100%;
                height: 100%;
                image-fit: contain;
            }
        }
        
        Text {
            text: title;
            font-size: 14px;
            font-weight: 700;
            horizontal-alignment: left;
            wrap: word-wrap;
        }
        
        Text {
            text: path;
            font-size: 12px;
            color: #666666;
            horizontal-alignment: left;
            wrap: word-wrap;
        }
    }
    
    TouchArea {
        clicked => {
            // Handle click event
        }
    }
}

export component MainWindow inherits Window {
    title: "PDF Reader";
    width: 1024px;
    height: 768px;
    
    in property <int> page-count: 0;
    in-out property <int> current-page: 0;
    in-out property <float> zoom: 1.0;
    in property <[PageData]> document-pages;
    in property <length> total-width: 0px;
    in property <length> total-height: 0px;
    in-out property <length> offset-x: 0px;
    in-out property <length> offset-y: 0px;
    in-out property <bool> scroll-events-enabled: true;
    in property <string> file-path: "/book/sample.pdf";
    in property <bool> document-opened: false;
    in property <[string]> history-items: [];
    
    callback open-file();
    callback page-changed(int);
    callback zoom-changed(float);
    callback viewport-changed(length, length);
    callback scroll-changed(length, length);
    callback back-to-history();
    
    Rectangle {

        VerticalBox {
            visible: !root.document-opened;
            
            Rectangle {
                height: 48px;
                background: #f5f5f5;
                border-width: 1px;
                border-color: #e0e0e0;
                
                HorizontalBox {
                    alignment: start;
                    padding: 12px;
                    spacing: 8px;
                    
                    Button {
                        text: "Clear";
                        clicked => { }
                    }
                    
                    Button {
                        text: "Open";
                        clicked => { open-file(); }
                    }
                }
            }
            
            GridLayout {
                spacing: 8px;

                HistoryItem {
                    width: 160px;
                    height: 180px;
                    title: "Sample Document 1";
                    path: "/path/to/document1.pdf";
                }

                HistoryItem {
                    width: 160px;
                    height: 180px;
                    title: "Sample Document 1";
                    path: "/path/to/document1.pdf";
                }
                
                HistoryItem {
                    width: 160px;
                    height: 180px;
                    title: "Sample Document 2";
                    path: "/path/to/document2.pdf";
                }
                
                HistoryItem {
                    width: 160px;
                    height: 180px;
                    title: "Sample Document 3";
                    path: "/path/to/document3.pdf";
                }
                
                HistoryItem {
                    width: 160px;
                    height: 180px;
                    title: "Sample Document 4";
                    path: "/path/to/document4.pdf";
                }
                    
                HistoryItem {
                    width: 160px;
                    height: 180px;
                    title: "Sample Document 5";
                    path: "/path/to/document5.pdf";
                }
            }
        }
        
        VerticalBox {
            visible: root.document-opened;

            Rectangle {
                height: 48px;
                background: #f5f5f5;
                border-width: 1px;
                border-color: #e0e0e0;
                
                HorizontalLayout {
                    alignment: space-between;
                    HorizontalLayout {
                        alignment: start;
                        padding: 12px;
                        spacing: 8px;

                        Button {
                            text: "Back";
                            clicked => { back-to-history(); }
                        }
                    
                        Text {
                            text: root.file-path;
                            vertical-alignment: center;
                            horizontal-alignment: left;
                            wrap: word-wrap;
                        }
                    }
                
                    HorizontalLayout {
                        alignment: end;

                        padding: 12px;
                        spacing: 8px;

                        Button {
                            text: "Previous";
                            enabled: root.current-page > 0;
                            clicked => { page-changed(root.current-page - 1); }
                        }
                    
                        Button {
                            text: "Next";
                            enabled: root.current-page < root.page-count - 1;
                            clicked => { page-changed(root.current-page + 1); }
                        }
                        
                        Button {
                            text: "Zoom -";
                            clicked => {
                                zoom = Math.max(0.5, zoom - 0.1);
                                zoom-changed(zoom);
                            }
                        }
                    
                        Button {
                            text: "Zoom +";
                            clicked => {
                                zoom = Math.min(4.0, zoom + 0.1);
                                zoom-changed(zoom);
                            }
                        }
    
                        Text {
                            text: Math.round(zoom * 100) + "%";
                            vertical-alignment: center;
                        }
    
                        Text {
                            text: "Page " + (root.current-page + 1) + " / " + Math.max(root.page-count, 1);
                            vertical-alignment: center;
                        }
                    }
                }
            }
            
            DocumentView {
                vertical-stretch: 1;
                min-height: 0px;
                pages: root.document-pages;
                total-width: root.total-width;
                total-height: root.total-height;
                offset-x <=> root.offset-x;
                offset-y <=> root.offset-y;
                enable-scroll-events: root.scroll-events-enabled;
                viewport-changed(width, height) => { root.viewport-changed(width, height); }
                scroll-changed(x, y) => { root.scroll-changed(x, y); }
            }
        }

        ListView {
            visible:false;
            width: 150px;
            for data in [
            { text: "Blue", color: #0000ff, bg: #eeeeee},
            { text: "Red", color: #ff0000, bg: #eeeeee},
            { text: "Green", color: #00ff00, bg: #eeeeee},
            { text: "Yellow", color: #ffff00, bg: #222222 },
            { text: "Black", color: #000000, bg: #eeeeee },
            { text: "White", color: #ffffff, bg: #222222 },
            { text: "Magenta", color: #ff00ff, bg: #eeeeee },
            { text: "Cyan", color: #00ffff, bg: #222222 },
            ] : Rectangle {
            height: 30px;
            background: data.bg;
            width: parent.width;
            Text {
                x: 0;
                text: data.text;
                color: data.color;
            }
            }
        }
    }
}